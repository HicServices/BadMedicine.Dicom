language: csharp
mono: none
dotnet: 3.1

cache:
  directories:
  - $HOME/.nuget

before_script:
- sudo apt install libc6-dev libgdiplus

services:
  - mysql
  
script:
- dotnet build
- dotnet test "./BadMedicine.Dicom.Tests/BadMedicine.Dicom.Tests.csproj"
- VERSION=`grep AssemblyInformationalVersion SharedAssemblyInfo.cs | cut -d'"' -f2`
- echo $VERSION
- sed -i "s/VERSION/$VERSION/g" ./BadMedicine.Dicom/BadMedicine.Dicom.nuspec
- cat ./BadMedicine.Dicom/BadMedicine.Dicom.nuspec
- dotnet pack ./BadMedicine.Dicom/BadMedicine.Dicom.csproj -c Release -p:NuspecFile=./BadMedicine.Dicom.nuspec
  -p:IncludeSymbols=true
- pwd
- |
  for platform in linux win
  do
    dotnet publish -c Release -r $platform-x64 -o $(pwd)/dist/$platform-x64 --self-contained false -nologo -v q
  done
- ( cd dist && zip -r baddicom-win-x64-$TRAVIS_TAG.zip ./win-x64 && tar czf baddicom-linux-x64-$TRAVIS_TAG.tar.gz ./linux-x64 && cd - )
    
- cd ./BadDicom/bin/Debug/netcoreapp3.1
- curl https://raw.githubusercontent.com/HicServices/DicomTypeTranslation/master/Templates/CT.it > ./CT.it
- mv BadDicom.template.yaml BadDicom.yaml
- dotnet ./BadDicom.dll ./ 50000 10 CT

- "sed -i \"s/Batches: 1/Batches: 5/g\" ./BadDicom.yaml"
- "sed -i \"s/DropTables: false/DropTables: true/g\" ./BadDicom.yaml"

- dotnet ./BadDicom.dll ./ 50000 10 CT

- cd ../../../..
- pwd 
- ls -lh dist

after_success:
- if [ -z "$TRAVIS_TAG" ]; then travis_terminate 0; fi
- dotnet nuget push "./BadMedicine.Dicom/bin/Release/HIC.BadMedicine.Dicom.$VERSION.nupkg"
  -s https://api.nuget.org/v3/index.json -k $NUGET_KEY || true

deploy:
  provider: releases
  api_key:
    secure: JOBiUeM5wgl2HQYUCTK4MS8VCZGWxA7d4mtyF+Li7MMW9keoB+DRwxtHcUnBLcFll8gmBRc/UolKbZHnni6FqsnsgokGPzilK+8ISgtL65ymMbUB1n+G0d3YTuH7mZPHEGEcziwowlxZzKh4wZRxl1mwI8o5P9rOOzUg32iaThPS2f+zD2a4BD1hUD71+9SOan6qL9PmDj79jLxP19nWvqb/tvfVbXtr8T3Nl4s/cqCwYI1R6OpnzmRUkgnBQ1tNilRxJKCAbye3iRXOyahceYqGnTU54OonJ0IbrOJXRnuk5w52VE54Wmipiv7m2lYVeM1K5EfqlrpQQvyzS29Imsyii+3/tlHJvWswNU1TcC3B4bH+d9YQPC5zLcjqbl23IGzU8NmDgrFfR6BtczJ0+mqY9M+mdLk8hWRluWP7C7LPFFSOsw3gqrVd/ocp4zr08J66Ze4lUvLe7e/cnp4xX22sdWfbTe88pj6fbS7Vh9bXGoDYB33xXeFH7gj+7fBPRPDsUx1HKZEnzOsDZ4iYq3W9o0PCfpa3VMFpgTuq+2cWLz+v9N6M6zYAcxNVuab3caluWqkXXlJs9zrHZWNpnw8dfdgC1kTiVvvUog1mUs9vH/XUY9TR1aBuViUDKvsCrPMtmiVB7BNcLUPbPXmP1obCHzlDEX4/LGHYR6IUxRM=
  file: dist/*.*
  file_glob: true
  on:
    repo: HicServices/BadMedicine.Dicom
    all_branches: true
    tags: true
